<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YASHU - Claude/Codex APIä¸­è½¬</title>
    <script src="chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }

        /* æ ‡é¢˜å¸ƒå±€æ ·å¼ */
        .header-title { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding: 15px 0; border-bottom: 3px solid #1E90FF; }
        .logo { font-size: 28px; font-weight: bold; color: #1E90FF; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .logo-dot { width: 14px; height: 14px; background: #28a745; border-radius: 50%; }
        .header-title h1 { flex: 1; text-align: center; font-size: 22px; margin: 0; color: #333; }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 14px; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; }
        .tab:hover { color: #0056b3; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-sm { padding: 5px 10px; font-size: 12px; margin: 0 2px; }
        .configs-list { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .config-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .config-item:last-child { border-bottom: none; }
        .config-item.disabled { background: #f8f9fa; opacity: 0.6; }
        .config-info { flex: 1; }
        .config-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .config-url { color: #666; font-size: 14px; margin-bottom: 3px; }
        .config-key { color: #999; font-size: 12px; font-family: monospace; }
        .priority-tag { display: inline-block; padding: 2px 6px; margin-right: 8px; border-radius: 12px; background: #f1f3f5; font-size: 12px; color: #444; }
        .mono-chip { font-family: monospace; background: #f0f0f0; padding: 2px 6px; border-radius: 3px; }
        .config-type { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-left: 10px; }
        .type-primary { background: #007bff; color: white; }
        .type-backup { background: #6c757d; color: white; }
        .config-actions { display: flex; gap: 5px; align-items: center; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 50px auto; padding: 30px; max-width: 500px; border-radius: 8px; }
        .modal-title { font-size: 20px; margin-bottom: 20px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .toast { position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 15px 20px; border-radius: 5px; z-index: 2000; display: none; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        
        /* ä¼˜åŒ–çš„å¼€å…³æ ·å¼ */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
        .switch .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .switch input:checked + .slider { background-color: #28a745; }
        .switch input:checked + .slider:before { transform: translateX(26px); }
        .switch input:focus + .slider { box-shadow: 0 0 1px #28a745; }

        /* è‡ªåŠ¨ä¿å­˜æç¤º */
        .auto-save-indicator { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; z-index: 2000; display: none; opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .auto-save-indicator.show { display: block; opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-title">
            <div class="logo">
                YASHU <span class="logo-dot"></span>
            </div>
            <h1>Claude code/Codex API ä¸­è½¬ç»Ÿä¸€é…ç½®ç®¡ç†</h1>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" data-tab="api" onclick="switchTab(event, 'api')">Claudeé…ç½®</button>
            <button class="tab" data-tab="codex" onclick="switchTab(event, 'codex')">Codexé…ç½®</button>
            <button class="tab" data-tab="openai-claude" onclick="switchTab(event, 'openai-claude')">OpenAIè½¬Claude</button>
            <button class="tab" data-tab="retry" onclick="switchTab(event, 'retry')">è¶…æ—¶é‡è¯•</button>
            <button class="tab" data-tab="model-conversion" onclick="switchTab(event, 'model-conversion')">ğŸ”„ æ¨¡å‹è½¬æ¢</button>
            <button class="tab" data-tab="timeout" onclick="switchTab(event, 'timeout')">â± è¶…æ—¶è®¾ç½®</button>
            <button class="tab" data-tab="error-strategies" onclick="switchTab(event, 'error-strategies')">âš ï¸ é”™è¯¯ç­–ç•¥</button>
            <button class="tab" data-tab="token-stats" onclick="switchTab(event, 'token-stats')">ğŸ“Š Tokenç»Ÿè®¡</button>
        </div>
        
        <div class="header">
            <div>
                <button class="btn btn-primary" id="addBtn" onclick="openAddModal()">â• æ·»åŠ </button>
                <button class="btn btn-secondary" onclick="loadConfigs()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-secondary" id="resetCooldownBtn" onclick="resetCooldown()" style="display: none;">ğŸ”„ é‡ç½®å†·å´</button>
            </div>
        </div>
        <div id="configsList" class="configs-list"></div>
    </div>

    <!-- è‡ªåŠ¨ä¿å­˜æç¤º -->
    <div id="autoSaveIndicator" class="auto-save-indicator">âœ… å·²è‡ªåŠ¨ä¿å­˜</div>

    <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">ç¼–è¾‘é…ç½®</h2>
            <input type="hidden" id="editIndex">
            <div class="form-group">
                <label>åç§°</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>APIåœ°å€</label>
                <input type="text" id="editUrl">
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="text" id="editKey">
            </div>
            <div class="form-group" id="typeGroup">
                <label>ç±»å‹</label>
                <select id="editType">
                    <option value="primary">ä¸»è¦API</option>
                    <option value="backup">å¤‡ç”¨API</option>
                </select>
            </div>
            <div class="form-group" id="timeEnabledGroup">
                <label>æ—¶é—´ä½¿èƒ½ï¼ˆå‘¨ä¸€è‡³å‘¨æ—¥ï¼‰</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="time_mon" checked> å‘¨ä¸€
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="time_tue" checked> å‘¨äºŒ
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="time_wed" checked> å‘¨ä¸‰
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="time_thu" checked> å‘¨å››
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="time_fri" checked> å‘¨äº”
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="time_sat" checked> å‘¨å…­
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="time_sun" checked> å‘¨æ—¥
                    </label>
                </div>
            </div>
            <div class="form-group" id="activationGroup">
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="editActivationEnabled">
                    <span>å¯ç”¨å®šæ—¶æ¿€æ´»ï¼ˆæ¯å¤©å›ºå®šæ—¶é—´å‘é€æ¿€æ´»è¯·æ±‚ï¼‰</span>
                </label>
                <div style="margin-top: 10px;">
                    <label>æ¿€æ´»æ—¶é—´ï¼ˆæ ¼å¼ï¼šHH:MMï¼‰</label>
                    <input type="time" id="editActivationTime" value="08:00" style="width: 150px;">
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                    ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>æŸäº›API Keyéœ€è¦åœ¨ç‰¹å®šæ—¶é—´æ¿€æ´»æ‰èƒ½å¼€å§‹è®¡æ—¶ã€‚å¯ç”¨åï¼Œç³»ç»Ÿä¼šåœ¨è®¾å®šæ—¶é—´è‡ªåŠ¨å‘é€æµ‹è¯•è¯·æ±‚æ¿€æ´»è¯¥Keyã€‚å¦‚å¤±è´¥ï¼Œæ¯1åˆ†é’Ÿé‡è¯•ä¸€æ¬¡ï¼Œæœ€å¤š20æ¬¡ã€‚
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="saveConfig()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let currentTab = 'api';
        let currentConfigs = [];
        let tokenStatsAutoRefreshTimer = null;  // è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        let lastTokenStatsData = null;  // ä¸Šä¸€æ¬¡çš„ç»Ÿè®¡æ•°æ®ï¼ˆç”¨äºæ¯”è¾ƒå˜åŒ–ï¼‰

        function switchTab(evt, tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const targetButton = evt?.currentTarget || evt?.target || document.querySelector(`.tab[data-tab="${tab}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // æ ¹æ®æ ‡ç­¾ç±»å‹æ˜¾ç¤º/éšè—æ·»åŠ æŒ‰é’®
            const addBtn = document.getElementById('addBtn');
            if (tab === 'timeout' || tab === 'error-strategies' || tab === 'token-stats') {
                addBtn.style.display = 'none';
            } else {
                addBtn.style.display = 'inline-block';
            }
            
            // æ ¹æ®æ ‡ç­¾ç±»å‹æ˜¾ç¤º/éšè—é‡ç½®å†·å´æŒ‰é’®
            const resetCooldownBtn = document.getElementById('resetCooldownBtn');
            if (tab === 'api' || tab === 'codex') {
                resetCooldownBtn.style.display = 'inline-block';
            } else {
                resetCooldownBtn.style.display = 'none';
            }

            // æ§åˆ¶Tokenç»Ÿè®¡è‡ªåŠ¨åˆ·æ–°
            if (tab === 'token-stats') {
                // åˆ‡æ¢åˆ°Tokenç»Ÿè®¡æ ‡ç­¾ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                startTokenStatsAutoRefresh();
            } else {
                // åˆ‡æ¢ç¦»å¼€Tokenç»Ÿè®¡æ ‡ç­¾ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
                stopTokenStatsAutoRefresh();
            }

            loadConfigs();
        }

        async function loadConfigs() {
            try {
                // å…ˆè°ƒç”¨reloadç«¯ç‚¹ï¼Œé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
                try {
                    await fetch('/api/reload', { method: 'POST' });
                } catch (reloadError) {
                    console.warn('é‡æ–°åŠ è½½é…ç½®å¤±è´¥:', reloadError);
                    // ç»§ç»­æ‰§è¡Œï¼Œå³ä½¿reloadå¤±è´¥ä¹Ÿèƒ½è¯»å–ç¼“å­˜çš„é…ç½®
                }
                
                let endpoint = '/api/configs';
                if (currentTab === 'codex') endpoint = '/api/codex';
                else if (currentTab === 'openai-claude') endpoint = '/api/openai-to-claude';
                else if (currentTab === 'retry') endpoint = '/api/retry';
                else if (currentTab === 'model-conversion') endpoint = '/api/model-conversion';
                else if (currentTab === 'timeout') endpoint = '/api/timeout';
                else if (currentTab === 'error-strategies') endpoint = '/api/error-strategies';
                else if (currentTab === 'token-stats') endpoint = '/api/token-stats';
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (currentTab === 'openai-claude') {
                    currentConfigs = data.configs || [];
                    renderOpenaiClaude(currentConfigs);
                } else if (currentTab === 'timeout') {
                    // åŠ è½½ä¼˜åŒ–è®¾ç½®å¹¶åˆå¹¶åˆ°è¶…æ—¶è®¾ç½®ä¸­
                    try {
                        const optResponse = await fetch('/api/optimization');
                        const optData = await optResponse.json();
                        const mergedSettings = { ...data.settings, ...optData.settings };
                        renderTimeoutSettings(mergedSettings);
                    } catch (error) {
                        console.warn('åŠ è½½ä¼˜åŒ–è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
                        renderTimeoutSettings(data.settings);
                    }
                } else if (currentTab === 'error-strategies') {
                    renderErrorStrategies(data.strategies);
                } else if (currentTab === 'model-conversion') {
                    currentConfigs = data.configs || [];
                    renderModelConversions(currentConfigs);
                } else if (currentTab === 'token-stats') {
                    lastTokenStatsData = data;  // ä¿å­˜æ•°æ®ç”¨äºåç»­æ¯”è¾ƒ
                    renderTokenStats(data);
                } else {
                    currentConfigs = data.configs || [];
                    renderConfigs(currentConfigs);
                }
            } catch (error) {
                showToast('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== Tokenç»Ÿè®¡è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ ==========

        // å¯åŠ¨Tokenç»Ÿè®¡è‡ªåŠ¨åˆ·æ–°
        function startTokenStatsAutoRefresh() {
            // æ¸…é™¤å·²å­˜åœ¨çš„å®šæ—¶å™¨
            stopTokenStatsAutoRefresh();

            // åˆ›å»ºæ–°çš„å®šæ—¶å™¨ï¼Œæ¯ç§’æ£€æŸ¥ä¸€æ¬¡
            tokenStatsAutoRefreshTimer = setInterval(async () => {
                await checkAndRefreshTokenStats();
            }, 1000);  // 1ç§’é—´éš”
        }

        // åœæ­¢Tokenç»Ÿè®¡è‡ªåŠ¨åˆ·æ–°
        function stopTokenStatsAutoRefresh() {
            if (tokenStatsAutoRefreshTimer) {
                clearInterval(tokenStatsAutoRefreshTimer);
                tokenStatsAutoRefreshTimer = null;
            }
        }

        // æ£€æŸ¥å¹¶åˆ·æ–°Tokenç»Ÿè®¡æ•°æ®
        async function checkAndRefreshTokenStats() {
            try {
                // è·å–æœ€æ–°çš„ç»Ÿè®¡æ•°æ®
                const response = await fetch('/api/token-stats');
                const newData = await response.json();

                // å°†æ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»¥ä¾¿æ¯”è¾ƒ
                const newDataStr = JSON.stringify(newData);
                const lastDataStr = lastTokenStatsData ? JSON.stringify(lastTokenStatsData) : null;

                // å¦‚æœæ•°æ®æœ‰å˜åŒ–ï¼Œåˆ™æ›´æ–°ç•Œé¢
                if (newDataStr !== lastDataStr) {
                    lastTokenStatsData = newData;
                    renderTokenStats(newData);
                }
            } catch (error) {
                console.error('è‡ªåŠ¨åˆ·æ–°Tokenç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        function renderOpenaiClaude(configs) {
            const list = document.getElementById('configsList');
            if (!configs || configs.length === 0) {
                list.innerHTML = '<div class="empty-state">æš‚æ— OpenAIè½¬Claudeé…ç½®ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            list.innerHTML = configs.map((cfg, index) => {
                const isEnabled = cfg.enabled !== false;
                const displayName = cfg.name || `OpenAIè½¬Claude-${index + 1}`;
                const priorityBadge = `<span class="priority-tag" title="ä¼˜å…ˆçº§è¶Šé å‰è¶Šä¼˜å…ˆ">#${index + 1}</span>`;
                const statusColor = isEnabled ? '#28a745' : '#dc3545';
                const statusLabel = isEnabled ? 'âœ“ å·²å¯ç”¨' : 'âœ— å·²ç¦ç”¨';
                const keyPreview = cfg.key ? `${cfg.key.substring(0, 20)}...` : 'æœªè®¾ç½®';
                const topDisabled = index === 0 ? 'disabled' : '';
                const bottomDisabled = index === configs.length - 1 ? 'disabled' : '';
                return `
                <div class="config-item ${isEnabled ? '' : 'disabled'}">
                    <div class="config-info">
                        <div class="config-name">
                            ${priorityBadge}
                            <span>${displayName}</span>
                            <span style="margin-left: 10px; font-size: 12px; color: ${statusColor};">${statusLabel}</span>
                        </div>
                        <div class="config-url">ğŸ”— ${cfg.base_url || 'æœªè®¾ç½®'}</div>
                        <div class="config-key">ğŸ”‘ ${keyPreview}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            è¯´æ˜ï¼šæŒ‰åˆ—è¡¨é¡ºåºä¼˜å…ˆä½¿ç”¨å¯ç”¨çš„é…ç½®ï¼Œæ— è‡ªåŠ¨åˆ‡æ¢ã€‚
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn ${isEnabled ? 'btn-warning' : 'btn-success'} btn-sm" title="åˆ‡æ¢å¯ç”¨çŠ¶æ€" onclick="toggleConfig(${index})">
                            ${isEnabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button class="btn btn-primary btn-sm" title="ç¼–è¾‘é…ç½®" onclick="openEditModal(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-secondary btn-sm" title="ä¸Šç§»ä¸€ä½" onclick="moveConfig(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="btn btn-secondary btn-sm" title="ä¸‹ç§»ä¸€ä½" onclick="moveConfig(${index}, 'down')" ${index === configs.length - 1 ? 'disabled' : ''}>â†“</button>
                        <button class="btn btn-secondary btn-sm" title="å¿«é€Ÿç½®é¡¶" onclick="moveConfig(${index}, 'top')" ${topDisabled}>â¤’</button>
                        <button class="btn btn-secondary btn-sm" title="å¿«é€Ÿç½®åº•" onclick="moveConfig(${index}, 'bottom')" ${bottomDisabled}>â¤“</button>
                        <button class="btn btn-info btn-sm" title="å¤åˆ¶ä¸€æ¡ç›¸åŒé…ç½®" onclick="duplicateConfig(${index})">å¤åˆ¶</button>
                        <button class="btn btn-danger btn-sm" title="åˆ é™¤é…ç½®" onclick="deleteConfig(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderConfigs(configs) {
            const list = document.getElementById('configsList');
            if (configs.length === 0) {
                list.innerHTML = '<div class="empty-state">æš‚æ— é…ç½®ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            const allowDuplicate = true;
            const showScheduling = currentTab === 'api' || currentTab === 'codex';
            list.innerHTML = configs.map((cfg, index) => {
                const priorityBadge = `<span class="priority-tag" title="ä¼˜å…ˆçº§è¶Šé å‰è¶Šä¼˜å…ˆ">#${index + 1}</span>`;
                const typeBadge = showScheduling && cfg.type ? `<span class="config-type type-${cfg.type}">${cfg.type === 'primary' ? 'ä¸»è¦' : 'å¤‡ç”¨'}</span>` : '';
                const statusColor = cfg.enabled !== false ? '#28a745' : '#dc3545';
                const statusLabel = cfg.enabled !== false ? 'âœ“ å·²å¯ç”¨' : 'âœ— å·²ç¦ç”¨';
                const keyPreview = cfg.key ? `${cfg.key.substring(0, 20)}...` : 'æœªé…ç½®';
                const weekDays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
                const timeInfo = showScheduling && Array.isArray(cfg.time_enabled)
                    ? 'â° å¯ç”¨æ—¶é—´: ' + weekDays.map((day, i) => cfg.time_enabled[i] ? `<span style="color: #28a745;">å‘¨${day}</span>` : `<span style="color: #ccc; text-decoration: line-through;">å‘¨${day}</span>`).join(' ')
                    : '';
                const activationInfo = showScheduling && cfg.activation_enabled
                    ? `<span style="color: #007bff;">ğŸ”” å®šæ—¶æ¿€æ´»: ${cfg.activation_time}</span>`
                    : '';
                const topDisabled = index === 0 ? 'disabled' : '';
                const bottomDisabled = index === configs.length - 1 ? 'disabled' : '';
                const duplicateButton = allowDuplicate ? `<button class="btn btn-info btn-sm" title="å¤åˆ¶ä¸€æ¡ç›¸åŒé…ç½®" onclick="duplicateConfig(${index})">å¤åˆ¶</button>` : '';
                return `
                <div class="config-item ${cfg.enabled === false ? 'disabled' : ''}">
                    <div class="config-info">
                        <div class="config-name">
                            ${priorityBadge}
                            <span>${cfg.name}</span>
                            ${typeBadge}
                            <span style="margin-left: 10px; font-size: 12px; color: ${statusColor}">${statusLabel}</span>
                        </div>
                        <div class="config-url">ğŸ”— ${cfg.base_url || 'æœªé…ç½®'}</div>
                        <div class="config-key">ğŸ”‘ ${keyPreview}</div>
                        ${timeInfo ? `<div class="config-time" style="font-size: 12px; color: #666; margin-top: 5px;">${timeInfo}</div>` : ''}
                        ${activationInfo ? `<div class="config-activation" style="font-size: 12px; margin-top: 5px;">${activationInfo}</div>` : ''}
                    </div>
                    <div class="config-actions">
                        <button class="btn ${cfg.enabled !== false ? 'btn-warning' : 'btn-success'} btn-sm" title="åˆ‡æ¢å¯ç”¨çŠ¶æ€" onclick="toggleConfig(${index})">
                            ${cfg.enabled !== false ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button class="btn btn-primary btn-sm" title="ç¼–è¾‘é…ç½®" onclick="openEditModal(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-secondary btn-sm" title="ä¸Šç§»ä¸€ä½" onclick="moveConfig(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="btn btn-secondary btn-sm" title="ä¸‹ç§»ä¸€ä½" onclick="moveConfig(${index}, 'down')" ${index === configs.length - 1 ? 'disabled' : ''}>â†“</button>
                        <button class="btn btn-secondary btn-sm" title="å¿«é€Ÿç½®é¡¶" onclick="moveConfig(${index}, 'top')" ${topDisabled}>â¤’</button>
                        <button class="btn btn-secondary btn-sm" title="å¿«é€Ÿç½®åº•" onclick="moveConfig(${index}, 'bottom')" ${bottomDisabled}>â¤“</button>
                        ${duplicateButton}
                        <button class="btn btn-danger btn-sm" title="åˆ é™¤é…ç½®" onclick="deleteConfig(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `;
            }).join('');
        }
        function renderModelConversions(configs) {
            const list = document.getElementById('configsList');
            if (configs.length === 0) {
                list.innerHTML = '<div class="empty-state">æš‚æ— æ¨¡å‹è½¬æ¢é…ç½®ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            list.innerHTML = configs.map((cfg, index) => {
                const priorityBadge = `<span class="priority-tag" title="ä¼˜å…ˆçº§è¶Šé å‰è¶Šä¼˜å…ˆ">#${index + 1}</span>`;
                const statusColor = cfg.enabled !== false ? '#28a745' : '#dc3545';
                const statusLabel = cfg.enabled !== false ? 'âœ“ å·²å¯ç”¨' : 'âœ— å·²ç¦ç”¨';
                const conversionType = cfg.conversion_type || 'simple_rename';
                const conversionTypeLabel = conversionType === 'full_format' ? 'å®Œæ•´æ ¼å¼è½¬æ¢' : 'ç®€å•æ¨¡å‹åæ›¿æ¢';
                const conversionTypeColor = conversionType === 'full_format' ? '#ff6b6b' : '#4ecdc4';
                const topDisabled = index === 0 ? 'disabled' : '';
                const bottomDisabled = index === configs.length - 1 ? 'disabled' : '';
                return `
                <div class="config-item ${cfg.enabled === false ? 'disabled' : ''}">
                    <div class="config-info">
                        <div class="config-name">
                            ${priorityBadge}
                            <span>${cfg.name}</span>
                            <span style="margin-left: 10px; font-size: 12px; color: ${statusColor}">${statusLabel}</span>
                        </div>
                        <div class="config-url" style="color: #333;">ğŸ“¥ æºæ¨¡å‹: <span class="mono-chip">${cfg.source_model}</span></div>
                        <div class="config-key" style="color: #333;">ğŸ“¤ ç›®æ ‡æ¨¡å‹: <span class="mono-chip">${cfg.target_model}</span></div>
                        <div style="color: ${conversionTypeColor}; font-size: 12px; margin-top: 5px;">ğŸ”§ è½¬æ¢ç±»å‹: ${conversionTypeLabel}</div>
                    </div>
                    <div class="config-actions">
                        <button class="btn ${cfg.enabled !== false ? 'btn-warning' : 'btn-success'} btn-sm" title="åˆ‡æ¢å¯ç”¨çŠ¶æ€" onclick="toggleConfig(${index})">
                            ${cfg.enabled !== false ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button class="btn btn-primary btn-sm" title="ç¼–è¾‘é…ç½®" onclick="openEditModal(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-secondary btn-sm" title="ä¸Šç§»ä¸€ä½" onclick="moveConfig(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="btn btn-secondary btn-sm" title="ä¸‹ç§»ä¸€ä½" onclick="moveConfig(${index}, 'down')" ${index === configs.length - 1 ? 'disabled' : ''}>â†“</button>
                        <button class="btn btn-secondary btn-sm" title="å¿«é€Ÿç½®é¡¶" onclick="moveConfig(${index}, 'top')" ${topDisabled}>â¤’</button>
                        <button class="btn btn-secondary btn-sm" title="å¿«é€Ÿç½®åº•" onclick="moveConfig(${index}, 'bottom')" ${bottomDisabled}>â¤“</button>
                        <button class="btn btn-info btn-sm" title="å¤åˆ¶ä¸€æ¡ç›¸åŒé…ç½®" onclick="duplicateConfig(${index})">å¤åˆ¶</button>
                        <button class="btn btn-danger btn-sm" title="åˆ é™¤é…ç½®" onclick="deleteConfig(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `;
            }).join('');
        }
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ é…ç½®';
            document.getElementById('editIndex').value = '-1';
            document.getElementById('editName').value = '';
            
            // ç§»é™¤ä¹‹å‰å¯èƒ½æ·»åŠ çš„æ¨¡å‹è½¬æ¢å­—æ®µ
            const sourceModelGroup = document.getElementById('sourceModelGroup');
            const targetModelGroup = document.getElementById('targetModelGroup');
            if (sourceModelGroup) sourceModelGroup.remove();
            if (targetModelGroup) targetModelGroup.remove();
            
            if (currentTab === 'model-conversion') {
                // æ¨¡å‹è½¬æ¢é…ç½®ï¼šéšè—URLå’ŒKeyå­—æ®µï¼Œæ·»åŠ æº/ç›®æ ‡æ¨¡å‹å­—æ®µ
                document.getElementById('editUrl').parentElement.style.display = 'none';
                document.getElementById('editKey').parentElement.style.display = 'none';
                
                const urlGroup = document.getElementById('editUrl').parentElement;
                const keyGroup = document.getElementById('editKey').parentElement;
                
                const sourceModelGroup = document.createElement('div');
                sourceModelGroup.className = 'form-group';
                sourceModelGroup.id = 'sourceModelGroup';
                sourceModelGroup.innerHTML = '<label>æºæ¨¡å‹</label><input type="text" id="editSourceModel">';
                urlGroup.parentElement.insertBefore(sourceModelGroup, urlGroup);
                
                const targetModelGroup = document.createElement('div');
                targetModelGroup.className = 'form-group';
                targetModelGroup.id = 'targetModelGroup';
                targetModelGroup.innerHTML = '<label>ç›®æ ‡æ¨¡å‹</label><input type="text" id="editTargetModel">';
                keyGroup.parentElement.insertBefore(targetModelGroup, keyGroup);
                
                const conversionTypeGroup = document.createElement('div');
                conversionTypeGroup.className = 'form-group';
                conversionTypeGroup.id = 'conversionTypeGroup';
                conversionTypeGroup.innerHTML = `
                    <label>è½¬æ¢ç±»å‹</label>
                    <select id="editConversionType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="simple_rename">ç®€å•æ¨¡å‹åæ›¿æ¢ï¼ˆåªæ”¹æ¨¡å‹åï¼Œä¿æŒæ‰€æœ‰å‚æ•°ï¼‰</option>
                        <option value="full_format">å®Œæ•´æ ¼å¼è½¬æ¢ï¼ˆè½¬æ¢messages/systemæ ¼å¼ï¼‰</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ğŸ’¡ æç¤ºï¼š<br>
                        â€¢ ç®€å•æ›¿æ¢ï¼šé€‚åˆåŒç‰ˆæœ¬æ¨¡å‹å‡çº§ï¼ˆå¦‚æ—§Sonnet 4â†’æ–°ç‰ˆï¼‰<br>
                        â€¢ å®Œæ•´è½¬æ¢ï¼šé€‚åˆè·¨ç‰ˆæœ¬APIæ ¼å¼å‡çº§ï¼ˆå¦‚Haiku 3.5â†’Sonnet 4ï¼‰
                    </div>
                `;
                const nameGroup = document.getElementById('editName').parentElement;
                nameGroup.parentElement.insertBefore(conversionTypeGroup, nameGroup.nextSibling);
                
                document.getElementById('editSourceModel').value = '';
                document.getElementById('editTargetModel').value = '';
                document.getElementById('editConversionType').value = 'simple_rename';
            } else {
                // éæ¨¡å‹è½¬æ¢é…ç½®ï¼šæ˜¾ç¤ºURLå’ŒKeyå­—æ®µ
                document.getElementById('editUrl').parentElement.style.display = 'block';
                document.getElementById('editKey').parentElement.style.display = 'block';
                document.getElementById('editUrl').value = '';
                document.getElementById('editKey').value = '';
            }
            
            document.getElementById('editType').value = 'primary';
            
            if (currentTab === 'api' || currentTab === 'codex') {
                document.getElementById('typeGroup').style.display = 'block';
                document.getElementById('timeEnabledGroup').style.display = 'block';
                document.getElementById('activationGroup').style.display = 'block';
                // é»˜è®¤å…¨éƒ¨é€‰ä¸­
                ['time_mon', 'time_tue', 'time_wed', 'time_thu', 'time_fri', 'time_sat', 'time_sun'].forEach(id => {
                    document.getElementById(id).checked = true;
                });
                // é»˜è®¤ä¸å¯ç”¨å®šæ—¶æ¿€æ´»
                document.getElementById('editActivationEnabled').checked = false;
                document.getElementById('editActivationTime').value = '08:00';
            } else {
                document.getElementById('typeGroup').style.display = 'none';
                document.getElementById('timeEnabledGroup').style.display = 'none';
                document.getElementById('activationGroup').style.display = 'none';
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function openEditModal(index) {
            const cfg = currentConfigs[index];
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é…ç½®';
            document.getElementById('editIndex').value = index;
            document.getElementById('editName').value = cfg.name || '';
            
            // å…ˆç§»é™¤ä¹‹å‰å¯èƒ½æ·»åŠ çš„æ¨¡å‹è½¬æ¢å­—æ®µ
            const oldSourceModelGroup = document.getElementById('sourceModelGroup');
            const oldTargetModelGroup = document.getElementById('targetModelGroup');
            if (oldSourceModelGroup) oldSourceModelGroup.remove();
            if (oldTargetModelGroup) oldTargetModelGroup.remove();
            
            if (currentTab === 'model-conversion') {
                // æ¨¡å‹è½¬æ¢é…ç½®ï¼šéšè—URLå’ŒKeyå­—æ®µï¼Œæ˜¾ç¤ºæº/ç›®æ ‡æ¨¡å‹å­—æ®µ
                const urlGroup = document.getElementById('editUrl').parentElement;
                const keyGroup = document.getElementById('editKey').parentElement;
                urlGroup.style.display = 'none';
                keyGroup.style.display = 'none';
                
                const sourceModelGroup = document.createElement('div');
                sourceModelGroup.className = 'form-group';
                sourceModelGroup.id = 'sourceModelGroup';
                sourceModelGroup.innerHTML = '<label>æºæ¨¡å‹</label><input type="text" id="editSourceModel">';
                urlGroup.parentElement.insertBefore(sourceModelGroup, urlGroup);
                
                const targetModelGroup = document.createElement('div');
                targetModelGroup.className = 'form-group';
                targetModelGroup.id = 'targetModelGroup';
                targetModelGroup.innerHTML = '<label>ç›®æ ‡æ¨¡å‹</label><input type="text" id="editTargetModel">';
                keyGroup.parentElement.insertBefore(targetModelGroup, keyGroup);
                
                // æ·»åŠ è½¬æ¢ç±»å‹é€‰æ‹©æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!document.getElementById('conversionTypeGroup')) {
                    const conversionTypeGroup = document.createElement('div');
                    conversionTypeGroup.className = 'form-group';
                    conversionTypeGroup.id = 'conversionTypeGroup';
                    conversionTypeGroup.innerHTML = `
                        <label>è½¬æ¢ç±»å‹</label>
                        <select id="editConversionType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="simple_rename">ç®€å•æ¨¡å‹åæ›¿æ¢ï¼ˆåªæ”¹æ¨¡å‹åï¼Œä¿æŒæ‰€æœ‰å‚æ•°ï¼‰</option>
                            <option value="full_format">å®Œæ•´æ ¼å¼è½¬æ¢ï¼ˆè½¬æ¢messages/systemæ ¼å¼ï¼‰</option>
                        </select>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ğŸ’¡ æç¤ºï¼š<br>
                            â€¢ ç®€å•æ›¿æ¢ï¼šé€‚åˆåŒç‰ˆæœ¬æ¨¡å‹å‡çº§ï¼ˆå¦‚æ—§Sonnet 4â†’æ–°ç‰ˆï¼‰<br>
                            â€¢ å®Œæ•´è½¬æ¢ï¼šé€‚åˆè·¨ç‰ˆæœ¬APIæ ¼å¼å‡çº§ï¼ˆå¦‚Haiku 3.5â†’Sonnet 4ï¼‰
                        </div>
                    `;
                    const nameGroup = document.getElementById('editName').parentElement;
                    nameGroup.parentElement.insertBefore(conversionTypeGroup, nameGroup.nextSibling);
                }
                
                document.getElementById('editSourceModel').value = cfg.source_model || '';
                document.getElementById('editTargetModel').value = cfg.target_model || '';
                document.getElementById('editConversionType').value = cfg.conversion_type || 'simple_rename';
            } else {
                // éæ¨¡å‹è½¬æ¢é…ç½®ï¼šæ˜¾ç¤ºURLå’ŒKeyå­—æ®µ
                document.getElementById('editUrl').parentElement.style.display = 'block';
                document.getElementById('editKey').parentElement.style.display = 'block';
                document.getElementById('editUrl').value = cfg.base_url || '';
                document.getElementById('editKey').value = cfg.key || '';
            }
            
            if (currentTab === 'api' || currentTab === 'codex') {
                document.getElementById('editType').value = cfg.type || 'primary';
                document.getElementById('typeGroup').style.display = 'block';
                document.getElementById('timeEnabledGroup').style.display = 'block';
                document.getElementById('activationGroup').style.display = 'block';
                // åŠ è½½time_enabledçŠ¶æ€
                const timeEnabled = cfg.time_enabled || [1, 1, 1, 1, 1, 1, 1];
                const timeIds = ['time_mon', 'time_tue', 'time_wed', 'time_thu', 'time_fri', 'time_sat', 'time_sun'];
                timeIds.forEach((id, i) => {
                    document.getElementById(id).checked = timeEnabled[i] === 1;
                });
                // åŠ è½½å®šæ—¶æ¿€æ´»çŠ¶æ€
                document.getElementById('editActivationEnabled').checked = cfg.activation_enabled || false;
                document.getElementById('editActivationTime').value = cfg.activation_time || '08:00';
            } else {
                document.getElementById('typeGroup').style.display = 'none';
                document.getElementById('timeEnabledGroup').style.display = 'none';
                document.getElementById('activationGroup').style.display = 'none';
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function saveConfig() {
            const index = document.getElementById('editIndex').value;
            const config = {
                name: document.getElementById('editName').value
            };
            
            if (currentTab === 'model-conversion') {
                // æ¨¡å‹è½¬æ¢é…ç½®ï¼šä½¿ç”¨æºæ¨¡å‹å’Œç›®æ ‡æ¨¡å‹
                config.source_model = document.getElementById('editSourceModel').value;
                config.target_model = document.getElementById('editTargetModel').value;
                config.conversion_type = document.getElementById('editConversionType').value;
                
                if (!config.source_model || !config.target_model) {
                    showToast('è¯·å¡«å†™æºæ¨¡å‹å’Œç›®æ ‡æ¨¡å‹', 'error');
                    return;
                }
            } else {
                // å…¶ä»–é…ç½®ï¼šä½¿ç”¨URLå’ŒKey
                config.base_url = document.getElementById('editUrl').value;
                config.key = document.getElementById('editKey').value;
                
                if (!config.base_url || !config.key) {
                    showToast('è¯·å¡«å†™APIåœ°å€å’ŒKey', 'error');
                    return;
                }
            }
            
            if (currentTab === 'api' || currentTab === 'codex') {
                config.type = document.getElementById('editType').value;
                // è¯»å–time_enabled
                const timeIds = ['time_mon', 'time_tue', 'time_wed', 'time_thu', 'time_fri', 'time_sat', 'time_sun'];
                config.time_enabled = timeIds.map(id => document.getElementById(id).checked ? 1 : 0);
                // è¯»å–å®šæ—¶æ¿€æ´»è®¾ç½®
                config.activation_enabled = document.getElementById('editActivationEnabled').checked;
                config.activation_time = document.getElementById('editActivationTime').value;
            }

            try {
                let endpoint = '/api/configs';
                let method = 'POST';
                
                if (currentTab === 'codex') {
                    endpoint = '/api/codex';
                    if (index !== '-1') {
                        endpoint += `/${index}`;
                        method = 'PUT';
                    }
                } else if (currentTab === 'openai-claude') {
                    endpoint = '/api/openai-to-claude';
                    if (index !== '-1') {
                        endpoint += `/${index}`;
                        method = 'PUT';
                    }
                } else if (currentTab === 'retry') {
                    endpoint = '/api/retry';
                    if (index !== '-1') {
                        endpoint += `/${index}`;
                        method = 'PUT';
                    }
                } else if (currentTab === 'model-conversion') {
                    endpoint = '/api/model-conversion';
                    if (index !== '-1') {
                        endpoint += `/${index}`;
                        method = 'PUT';
                    }
                } else if (currentTab === 'api') {
                    if (index !== '-1') {
                        endpoint += `/${index}`;
                        method = 'PUT';
                    }
                }
                
                const response = await fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    closeEditModal();
                    loadConfigs();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteConfig(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—?')) return;

            try {
                let endpoint;
                if (currentTab === 'codex') {
                    endpoint = `/api/codex/${index}`;
                } else if (currentTab === 'openai-claude') {
                    endpoint = `/api/openai-to-claude/${index}`;
                } else if (currentTab === 'retry') {
                    endpoint = `/api/retry/${index}`;
                } else if (currentTab === 'model-conversion') {
                    endpoint = `/api/model-conversion/${index}`;
                } else {
                    endpoint = `/api/configs/${index}`;
                }
                const response = await fetch(endpoint, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadConfigs();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function toggleConfig(index) {
            try {
                let endpoint;
                if (currentTab === 'codex') {
                    endpoint = `/api/codex/${index}/toggle`;
                } else if (currentTab === 'openai-claude') {
                    endpoint = `/api/openai-to-claude/${index}/toggle`;
                } else if (currentTab === 'retry') {
                    endpoint = `/api/retry/${index}/toggle`;
                } else if (currentTab === 'model-conversion') {
                    endpoint = `/api/model-conversion/${index}/toggle`;
                } else {
                    endpoint = `/api/configs/${index}/toggle`;
                }
                const response = await fetch(endpoint, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadConfigs();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function moveConfig(index, direction) {
            try {
                let endpoint;
                if (currentTab === 'codex') {
                    endpoint = `/api/codex/${index}/move`;
                } else if (currentTab === 'openai-claude') {
                    endpoint = `/api/openai-to-claude/${index}/move`;
                } else if (currentTab === 'retry') {
                    endpoint = `/api/retry/${index}/move`;
                } else if (currentTab === 'model-conversion') {
                    endpoint = `/api/model-conversion/${index}/move`;
                } else {
                    endpoint = `/api/configs/${index}/move`;
                }
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ direction })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadConfigs();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('ç§»åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function duplicateConfig(index) {
            try {
                let endpoint;
                if (currentTab === 'codex') {
                    endpoint = `/api/codex/${index}/duplicate`;
                } else if (currentTab === 'openai-claude') {
                    endpoint = `/api/openai-to-claude/${index}/duplicate`;
                } else if (currentTab === 'model-conversion') {
                    endpoint = `/api/model-conversion/${index}/duplicate`;
                } else if (currentTab === 'retry') {
                    endpoint = `/api/retry/${index}/duplicate`;
                } else {
                    endpoint = `/api/configs/${index}/duplicate`;
                }
                const response = await fetch(endpoint, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    loadConfigs();
                } else {
                    showToast(data.message || 'å¤åˆ¶å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('å¤åˆ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function resetCooldown() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å†·å´çŠ¶æ€å—ï¼Ÿ')) {
                return;
            }
            
            try {
                let endpoint;
                if (currentTab === 'api') {
                    endpoint = '/api/reset-api-cooldown';
                } else if (currentTab === 'codex') {
                    endpoint = '/api/reset-codex-cooldown';
                } else {
                    showToast('å½“å‰æ ‡ç­¾é¡µä¸æ”¯æŒé‡ç½®å†·å´', 'error');
                    return;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadConfigs();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('é‡ç½®å†·å´å¤±è´¥: ' + error.message, 'error');
            }
        }

        function renderTimeoutSettings(settings) {
            const list = document.getElementById('configsList');
            
            // æŒ‰åŠŸèƒ½åˆ†ç±»çš„è¶…æ—¶é…ç½®ï¼šé€šç”¨ã€Claudeã€Codex
            const timeoutCategories = [
                {
                    category: 'é€šç”¨HTTPè¶…æ—¶è®¾ç½®',
                    icon: 'ğŸŒ',
                    desc: 'æ‰€æœ‰HTTPè¯·æ±‚å…±ç”¨çš„åŸºç¡€è¶…æ—¶å‚æ•°ï¼ˆé€‚ç”¨äºClaudeå’ŒCodexï¼‰',
                    fields: [
                        {key: 'connect_timeout', label: 'æ™®é€šè¿æ¥è¶…æ—¶', desc: 'å»ºç«‹TCPè¿æ¥çš„æœ€é•¿ç­‰å¾…æ—¶é—´ï¼ˆä»å¼€å§‹è¿æ¥åˆ°è¿æ¥æˆåŠŸï¼‰ã€‚æ‰€æœ‰è¯·æ±‚çš„ç¬¬ä¸€æ­¥éƒ½éœ€è¦å…ˆå»ºç«‹è¿æ¥ã€‚ç½‘ç»œè¾ƒæ…¢æ—¶å¯èƒ½éœ€è¦å¢åŠ ', default: 60},
                        {key: 'write_timeout', label: 'å†™å…¥è¶…æ—¶', desc: 'å‘æœåŠ¡å™¨å†™å…¥è¯·æ±‚æ•°æ®çš„æœ€é•¿ç­‰å¾…æ—¶é—´ï¼ˆä¸Šä¼ é˜¶æ®µï¼‰ã€‚å¤§è¯·æ±‚ä½“æ—¶å¯èƒ½éœ€è¦å¢åŠ ã€‚ä¸è¯»å–è¶…æ—¶åˆ†ç¦»ï¼Œä¸“é—¨æ§åˆ¶ä¸Šä¼ ', default: 60},
                        {key: 'pool_timeout', label: 'è¿æ¥æ± è¶…æ—¶', desc: 'ä»è¿æ¥æ± è·å–å¯ç”¨è¿æ¥çš„æœ€é•¿ç­‰å¾…æ—¶é—´ï¼ˆç­‰å¾…æ± ä¸­æœ‰ç©ºé—²è¿æ¥ï¼‰ã€‚é«˜å¹¶å‘æ—¶æ± æ»¡å¯èƒ½éœ€è¦ç­‰å¾…ï¼Œå¢å¤§æ­¤å€¼å¯æé«˜å¹¶å‘å®¹é”™', default: 120},
                        {key: 'extended_connect_timeout', label: 'æ‰©å±•è¿æ¥è¶…æ—¶', desc: 'é‡è¯•å’Œç­–ç•¥é‡è¯•ä¸“ç”¨çš„è¿æ¥è¶…æ—¶ï¼ˆæ¯”æ™®é€šè¿æ¥è¶…æ—¶æ›´é•¿ï¼‰ã€‚å¤±è´¥åè‡ªåŠ¨ä½¿ç”¨æ›´é•¿çš„è¿æ¥æ—¶é—´ï¼Œé¿å…äºŒæ¬¡å¤±è´¥ã€‚ä¸æ™®é€šè¿æ¥è¶…æ—¶åˆ†ç¦»ï¼Œä¸“é—¨ä¼˜åŒ–é‡è¯•æˆåŠŸç‡', default: 90}
                    ]
                },
                {
                    category: 'Claude APIè¶…æ—¶è®¾ç½®',
                    icon: 'ğŸ’¬',
                    desc: 'Claude APIè¯·æ±‚çš„ä¸“ç”¨è¶…æ—¶é…ç½®ã€é‡è¯•ç­–ç•¥ã€APIåˆ‡æ¢å’Œå¥åº·ç®¡ç†',
                    fields: [
                        {key: 'streaming_read_timeout', label: 'æµå¼è¯»å–è¶…æ—¶', desc: 'Claudeæµå¼å“åº”ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰çš„å•æ¬¡è¯»å–è¶…æ—¶ï¼ˆç­‰å¾…ä¸‹ä¸€ä¸ªæ•°æ®å—ï¼‰ã€‚æµå¼è¾“å‡ºè¾ƒæ…¢æ—¶å¯å¢åŠ ã€‚ä¸éæµå¼è¯»å–åˆ†ç¦»ï¼Œä¸“é—¨æ§åˆ¶æµå¼åœºæ™¯', default: 60},
                        {key: 'non_streaming_read_timeout', label: 'éæµå¼è¯»å–è¶…æ—¶', desc: 'Claudeéæµå¼å“åº”ï¼ˆä¸€æ¬¡æ€§å…¨éƒ¨è¿”å›ï¼‰çš„è¯»å–è¶…æ—¶ï¼ˆç­‰å¾…å®Œæ•´å“åº”ï¼‰ã€‚å¤æ‚ä»»åŠ¡è€—æ—¶é•¿æ—¶å¯å¢åŠ ã€‚ä¸æµå¼è¯»å–åˆ†ç¦»ï¼Œä¸“é—¨æ§åˆ¶éæµå¼åœºæ™¯', default: 60},
                        {key: 'strategy_retry_read_timeout', label: 'ç­–ç•¥é‡è¯•è¯»å–è¶…æ—¶', desc: 'ç­–ç•¥é‡è¯•èŠ‚ç‚¹ï¼ˆè¶…æ—¶é‡è¯•é…ç½®åˆ—è¡¨ï¼‰çš„ä¸“ç”¨è¯»å–è¶…æ—¶ã€‚è§¦å‘400/404/429/500/502/503ç­‰é”™è¯¯æ—¶ï¼Œä¾æ¬¡å°è¯•å¤‡ç”¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”¨æ­¤è¶…æ—¶ã€‚è®¾ç½®è¾ƒå¤§å€¼ï¼ˆå¦‚200ç§’ï¼‰å¯å¤§å¹…æé«˜å®¹é”™èƒ½åŠ›ã€‚ä¸æ™®é€šè¯»å–è¶…æ—¶åˆ†ç¦»ï¼Œä¸“é—¨ä¼˜åŒ–ç­–ç•¥é‡è¯•æˆåŠŸç‡', default: 200},
                        {key: 'api_cooldown_seconds', label: 'APIå†·å´æ—¶é—´', desc: 'APIè¿ç»­é”™è¯¯è¾¾åˆ°åˆ‡æ¢é˜ˆå€¼åè¿›å…¥å†·å´çŠ¶æ€çš„æ—¶é•¿ï¼ˆè‡ªåŠ¨æš‚åœä½¿ç”¨è¯¥KEYï¼‰ã€‚å†·å´æœŸé—´è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨KEYï¼Œå®šæ—¶æ£€æµ‹ä¸»KEYæ˜¯å¦æ¢å¤ã€‚å¢å¤§å¯é¿å…é¢‘ç¹åˆ‡æ¢', default: 600},
                        {key: 'api_error_threshold', label: 'APIé”™è¯¯é˜ˆå€¼', desc: 'è¿ç»­å¤±è´¥è¾¾åˆ°æ­¤æ¬¡æ•°æ—¶è§¦å‘APIåˆ‡æ¢å¹¶å¯åŠ¨å†·å´æµç¨‹ã€‚é»˜è®¤3æ¬¡ï¼Œå¯æ ¹æ®ç¨³å®šæ€§å’Œå®¹é”™éœ€æ±‚è°ƒæ•´', default: 3},
                        {key: 'primary_api_check_interval', label: 'ä¸»APIæ£€æµ‹é—´éš”', desc: 'ä½¿ç”¨å¤‡ç”¨APIæ—¶ï¼Œåå°æ£€æµ‹ä¸»APIæ˜¯å¦æ¢å¤çš„æ—¶é—´é—´éš”ï¼ˆå®šæ—¶æ¢æµ‹ï¼‰ã€‚è¶ŠçŸ­æ¢å¤è¶Šå¿«ï¼Œä½†ä¼šå¢åŠ è¯·æ±‚é‡ã€‚ä¸»APIæ¢å¤åè‡ªåŠ¨åˆ‡å›', default: 30},
                        {key: 'health_check_interval', label: 'å¥åº·æ£€æŸ¥é—´éš”', desc: 'APIå¥åº·æ£€æŸ¥å®ˆæŠ¤çº¿ç¨‹çš„è½®è¯¢é—´éš”ï¼ˆå®šæœŸå‘æ‰€æœ‰KEYå‘é€æµ‹è¯•è¯·æ±‚ï¼‰ã€‚è®¾ç½®ä¸º0å¯ç¦ç”¨å¥åº·æ£€æŸ¥ã€‚å¼€å¯å¯æå‰å‘ç°KEYå¤±æ•ˆ', default: 0.5},
                        {key: 'stream_retry_wait', label: 'æµé‡è¯•ç­‰å¾…', desc: 'æµå¼å“åº”ä¸­æ–­åï¼Œé‡æ–°å‘èµ·è¯·æ±‚å‰çš„ç­‰å¾…æ—¶é—´ï¼ˆé¿å…ç«‹å³é‡è¯•å¯¼è‡´é‡å¤é”™è¯¯ï¼‰ã€‚ç»™æœåŠ¡ç«¯æ¢å¤æ—¶é—´ï¼Œå‡å°‘æ— æ„ä¹‰é‡è¯•', default: 1.0},
                        {key: 'billing_cycle_delay', label: 'è®¡è´¹å‘¨æœŸå»¶æ—¶', desc: 'è®¡è´¹æ¿€æ´»å®ˆæŠ¤çº¿ç¨‹çš„å¯åŠ¨å»¶è¿Ÿï¼ˆæœåŠ¡å¯åŠ¨åç­‰å¾…å¤šä¹…å¼€å§‹è®¡è´¹å¾ªç¯ï¼‰ã€‚é¿å…ä¸æœåŠ¡åˆå§‹åŒ–å†²çª', default: 60},
                        {key: 'billing_send_interval', label: 'è®¡è´¹å‘é€é—´éš”', desc: 'è®¡è´¹æ¿€æ´»æ¶ˆæ¯å‘é€ä¹‹é—´çš„é—´éš”ï¼ˆå‘å¤šä¸ªKEYå‘é€æ—¶çš„ç­‰å¾…é—´éš”ï¼‰ã€‚é¿å…ç¬é—´å¤§é‡è¯·æ±‚è§¦å‘é™æµ', default: 1.0},
                        {key: 'max_retries', label: 'æœ€å¤§é‡è¯•æ¬¡æ•°', desc: 'Claudeè¯·æ±‚çš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆswitch_apiç­–ç•¥ä½¿ç”¨ï¼‰ã€‚æ¯ä¸ªè¯·æ±‚åœ¨åŒä¸€APIä¸Šæœ€å¤šé‡è¯•æ­¤æ¬¡æ•°ï¼Œæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥åæ‰è®°å½•ä¸€æ¬¡é”™è¯¯ã€‚é»˜è®¤4æ¬¡', default: 4}
                    ]
                },
                {
                    category: 'Codexä¸“ç”¨è¶…æ—¶è®¾ç½®',
                    icon: 'ğŸ¤–',
                    desc: 'Codexä»£ç ç”Ÿæˆä»»åŠ¡çš„è‡ªé€‚åº”è¶…æ—¶æœºåˆ¶ï¼ˆé’ˆå¯¹ä»£ç ç”Ÿæˆçš„ç‰¹æ®Šéœ€æ±‚ï¼‰',
                    fields: [
                        {key: 'codex_connect_timeout', label: 'Codexè¿æ¥è¶…æ—¶', desc: 'Codexè¯·æ±‚å»ºç«‹è¿æ¥çš„ä¸“ç”¨è¶…æ—¶ï¼ˆasyncio.wait_foræ§åˆ¶åˆæ¬¡è¿æ¥ï¼‰ã€‚ä¸Claudeçš„æ™®é€šè¿æ¥è¶…æ—¶åˆ†ç¦»ï¼ŒCodexå¯å•ç‹¬è°ƒä¼˜', default: 30},
                        {key: 'codex_base_timeout', label: 'CodexåŸºç¡€è¶…æ—¶', desc: 'Codexæµå¼è¯·æ±‚çš„åˆå§‹æ€»è¶…æ—¶ï¼ˆä»£ç ç”Ÿæˆä»»åŠ¡çš„èµ·å§‹ç­‰å¾…æ—¶é—´ï¼‰ã€‚è‡ªé€‚åº”æœºåˆ¶çš„åŸºå‡†å€¼ï¼Œè¶…æ—¶åä¼šè‡ªåŠ¨å¢åŠ ', default: 60},
                        {key: 'codex_timeout_increment', label: 'Codexè¶…æ—¶å¢é‡', desc: 'Codexè¶…æ—¶åæ¯æ¬¡è‡ªåŠ¨å¢åŠ çš„æ—¶é—´ï¼ˆç´¯åŠ åˆ°åŸºç¡€è¶…æ—¶ï¼‰ã€‚è¿ç»­è¶…æ—¶ä¼šç´¯åŠ æ­¤å€¼ï¼Œè¿ç»­3æ¬¡æˆåŠŸä¼šé‡ç½®ã€‚è‡ªé€‚åº”ä¼˜åŒ–Codexé•¿ä»»åŠ¡å®¹é”™', default: 60},
                        {key: 'codex_error_threshold', label: 'Codexé”™è¯¯é˜ˆå€¼', desc: 'Codexè¿ç»­å¤±è´¥è¾¾åˆ°æ­¤æ¬¡æ•°æ—¶è§¦å‘KEYåˆ‡æ¢å¹¶è¿›å…¥å†·å´ã€‚é»˜è®¤3æ¬¡ï¼Œå¯å•ç‹¬è°ƒä¼˜ä¸ä¸»APIé˜ˆå€¼', default: 3}
                    ],
                },
                {
                    category: 'é«˜çº§é‡è¯•è®¾ç½®',
                    icon: 'ğŸ”§',
                    desc: 'é‡è¯•æœºåˆ¶çš„é«˜çº§é…ç½®é€‰é¡¹ï¼ˆæ§åˆ¶é‡è¯•è¡Œä¸ºçš„ç»†èŠ‚ï¼‰',
                    fields: [
                        {key: 'modify_retry_headers', label: 'é‡è¯•æ—¶ä¿®æ”¹è¯·æ±‚å¤´', desc: 'æ§åˆ¶é‡è¯•è¯·æ±‚çš„å¤´ä¿¡æ¯å¤„ç†æ–¹å¼ã€‚âœ… å¼€å¯ï¼ˆæ¨èï¼‰ï¼šè‡ªåŠ¨æ·»åŠ é˜²ç¼“å­˜å¤´å’Œå”¯ä¸€æ ‡è¯†ï¼Œç¡®ä¿æ¯æ¬¡é‡è¯•éƒ½æ˜¯å…¨æ–°è¯·æ±‚ï¼›âšª å…³é—­ï¼šä¿æŒåŸå§‹è¯·æ±‚å¤´ä¸å˜ï¼Œé€‚ç”¨äºå¯¹å¤´ä¿¡æ¯æ•æ„Ÿçš„ç‰¹æ®ŠAPI', default: true, type: 'boolean'}
                    ]
                },
                {
                    category: 'æ€§èƒ½ä¼˜åŒ–è®¾ç½®',
                    icon: 'âš¡',
                    desc: 'ä¼˜åŒ–APIè°ƒç”¨æ€§èƒ½å’Œå“åº”é€Ÿåº¦çš„åŠŸèƒ½å¼€å…³ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚çµæ´»å¯ç”¨',
                    fields: [
                        {key: 'enable_cache_control_limit', label: 'cache_controlå—æ•°é‡é™åˆ¶', desc: 'âœ… å¼€å¯ï¼ˆæ¨èï¼‰ï¼šè‡ªåŠ¨é™åˆ¶è¯·æ±‚ä¸­çš„cache_controlå—æ•°é‡ä¸è¶…è¿‡3ä¸ªï¼Œé˜²æ­¢Claude APIè¿”å›400é”™è¯¯ï¼›âšª å…³é—­ï¼šä¸é™åˆ¶cache_controlå—æ•°é‡ï¼ˆå¯èƒ½å¯¼è‡´è¶…é™æ—¶400é”™è¯¯ï¼‰', default: true, type: 'boolean'}
                    ]
                }
            ];
            
            let html = '<div style="padding: 20px;"><h3 style="margin-bottom: 20px;">â± è¶…æ—¶æ—¶é—´è®¾ç½®</h3>';
            html += '<div style="margin-bottom: 20px; padding: 12px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px; font-size: 13px; color: #1565C0;">';
            html += 'ğŸ’¡ <strong>é…ç½®è¯´æ˜</strong>ï¼šè¶…æ—¶è®¾ç½®å½±å“è¯·æ±‚çš„ç¨³å®šæ€§å’Œå“åº”é€Ÿåº¦ã€‚ç½‘ç»œç¯å¢ƒå·®æ—¶é€‚å½“å¢åŠ è¶…æ—¶å€¼ï¼Œç¨³å®šç¯å¢ƒå¯é€‚å½“é™ä½ã€‚æ‰©å±•è¿æ¥è¶…æ—¶å·²ä¼˜åŒ–ä¸º90ç§’ï¼Œç”¨äºé‡è¯•å’Œç­–ç•¥é‡è¯•ã€‚';
            html += '</div>';
            
            timeoutCategories.forEach(category => {
                html += `
                    <div style="margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 15px; font-weight: bold;">
                            ${category.icon} ${category.category}
                        </div>
                        <div style="padding: 15px; background: #fafafa;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 15px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #667eea;">
                                ${category.desc}
                            </div>
                            ${category.fields.map(field => {
                                const value = settings[field.key] !== undefined ? settings[field.key] : field.default;
                                
                                // å¸ƒå°”å€¼å­—æ®µæ¸²æŸ“ä¸ºå¼€å…³
                                if (field.type === 'boolean') {
                                    const checked = value ? 'checked' : '';
                                    const statusText = value ? 'âœ… å¼€å¯' : 'âšª å…³é—­';
                                    const statusColor = value ? '#28a745' : '#6c757d';
                                    return `
                                        <div class="form-group" style="margin-bottom: 15px; background: white; padding: 12px; border-radius: 6px; border: 1px solid #e8e8e8;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                <label style="font-weight: 500; color: #333;">${field.label}</label>
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <span id="status_${field.key}" style="font-size: 12px; color: ${statusColor}; font-weight: 500;">${statusText}</span>
                                                    <label class="switch">
                                                        <input type="checkbox" id="timeout_${field.key}" ${checked}
                                                               onchange="handleAutoSave(this, '${field.key}')">
                                                        <span class="slider"></span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                                <span style="color: #2196F3;">â„¹ï¸</span> ${field.desc}
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // æ•°ç»„å­—æ®µæ¸²æŸ“ä¸ºæ–‡æœ¬è¾“å…¥æ¡†
                                if (field.type === 'array') {
                                    const arrayValue = Array.isArray(value) ? value.join(',') : field.default.join(',');
                                    return `
                                        <div class="form-group" style="margin-bottom: 15px; background: white; padding: 12px; border-radius: 6px; border: 1px solid #e8e8e8;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                                <label style="font-weight: 500; color: #333;">${field.label}</label>
                                                <span style="font-size: 11px; color: #999;">é»˜è®¤: ${field.default.join(',')}</span>
                                            </div>
                                            <input type="text" id="timeout_${field.key}" value="${arrayValue}"
                                                   placeholder="ç”¨é€—å·åˆ†éš”å¤šä¸ªçŠ¶æ€ç ï¼Œä¾‹å¦‚ï¼š400,404,429,500,502,503"
                                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;"
                                                   onchange="handleAutoSave(this)">
                                            <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                                <span style="color: #2196F3;">â„¹ï¸</span> ${field.desc}
                                            </div>
                                        </div>
                                    `;
                                }

                                // æ•°å­—å­—æ®µæ¸²æŸ“ä¸ºè¾“å…¥æ¡†
                                return `
                                    <div class="form-group" style="margin-bottom: 15px; background: white; padding: 12px; border-radius: 6px; border: 1px solid #e8e8e8;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                            <label style="font-weight: 500; color: #333;">${field.label}</label>
                                            <span style="font-size: 11px; color: #999;">é»˜è®¤: ${field.default}ç§’</span>
                                        </div>
                                        <input type="number" id="timeout_${field.key}" value="${value}" step="0.1" min="0"
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;"
                                               onchange="handleAutoSave(this)">
                                        <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                            <span style="color: #2196F3;">â„¹ï¸</span> ${field.desc}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div class="form-actions" style="justify-content: flex-start; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="loadConfigs()">ğŸ”„ é‡ç½®ä¸ºå½“å‰é…ç½®</button>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px; font-size: 13px; color: #1565C0; border-left: 4px solid #2196F3;">
                    <strong>âœ¨ è‡ªåŠ¨ä¿å­˜æç¤º</strong><br>
                    â€¢ æ‰€æœ‰è®¾ç½®é¡¹ä¿®æ”¹åä¼š<strong>è‡ªåŠ¨ä¿å­˜</strong>ï¼Œæ— éœ€ç‚¹å‡»ä¿å­˜æŒ‰é’®<br>
                    â€¢ ä¿®æ”¹è¶…æ—¶è®¾ç½®åä¼šç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡<br>
                    â€¢ æ‰©å±•è¿æ¥è¶…æ—¶ï¼ˆ90ç§’ï¼‰ä¼šè‡ªåŠ¨ç”¨äºé‡è¯•å’Œç­–ç•¥é‡è¯•ï¼Œæé«˜æˆåŠŸç‡<br>
                    â€¢ å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é…ç½®ï¼Œå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ<br>
                    â€¢ å¦‚é‡åˆ°é¢‘ç¹è¶…æ—¶ï¼Œä¼˜å…ˆæ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIæœåŠ¡çŠ¶æ€
                </div>
            </div>`;
            list.innerHTML = html;
        }

        // è‡ªåŠ¨ä¿å­˜å¤„ç†å‡½æ•°
        let autoSaveTimeout = null;
        async function handleAutoSave(element, fieldKey) {
            // å¦‚æœæ˜¯å¸ƒå°”å€¼ï¼Œç«‹å³æ›´æ–°çŠ¶æ€æ–‡æœ¬
            if (element.type === 'checkbox' && fieldKey) {
                const statusSpan = document.getElementById(`status_${fieldKey}`);
                if (statusSpan) {
                    statusSpan.textContent = element.checked ? 'âœ… å¼€å¯' : 'âšª å…³é—­';
                    statusSpan.style.color = element.checked ? '#28a745' : '#6c757d';
                }
            }

            // å»¶è¿Ÿä¿å­˜ï¼ˆé˜²æŠ–ï¼‰ï¼Œé¿å…é¢‘ç¹ä¿å­˜
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                await saveTimeoutSettings(true); // trueè¡¨ç¤ºè‡ªåŠ¨ä¿å­˜
            }, 500); // 500msåä¿å­˜
        }

        // æ˜¾ç¤ºè‡ªåŠ¨ä¿å­˜æç¤º
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000); // 2ç§’åæ¶ˆå¤±
        }

        async function saveTimeoutSettings(isAutoSave = false) {
            try {
                const settings = {
                    connect_timeout: parseFloat(document.getElementById('timeout_connect_timeout').value),
                    write_timeout: parseFloat(document.getElementById('timeout_write_timeout').value),
                    pool_timeout: parseFloat(document.getElementById('timeout_pool_timeout').value),
                    streaming_read_timeout: parseFloat(document.getElementById('timeout_streaming_read_timeout').value),
                    non_streaming_read_timeout: parseFloat(document.getElementById('timeout_non_streaming_read_timeout').value),
                    extended_connect_timeout: parseFloat(document.getElementById('timeout_extended_connect_timeout').value),
                    api_cooldown_seconds: parseInt(document.getElementById('timeout_api_cooldown_seconds').value),
                    api_error_threshold: parseInt(document.getElementById('timeout_api_error_threshold').value),
                    codex_base_timeout: parseInt(document.getElementById('timeout_codex_base_timeout').value),
                    codex_timeout_increment: parseInt(document.getElementById('timeout_codex_timeout_increment').value),
                    codex_error_threshold: parseInt(document.getElementById('timeout_codex_error_threshold').value),
                    codex_connect_timeout: parseFloat(document.getElementById('timeout_codex_connect_timeout').value),
                    primary_api_check_interval: parseInt(document.getElementById('timeout_primary_api_check_interval').value),
                    billing_cycle_delay: parseInt(document.getElementById('timeout_billing_cycle_delay').value),
                    health_check_interval: parseFloat(document.getElementById('timeout_health_check_interval').value),
                    billing_send_interval: parseFloat(document.getElementById('timeout_billing_send_interval').value),
                    stream_retry_wait: parseFloat(document.getElementById('timeout_stream_retry_wait').value),
                    strategy_retry_read_timeout: parseFloat(document.getElementById('timeout_strategy_retry_read_timeout').value),
                    modify_retry_headers: document.getElementById('timeout_modify_retry_headers').checked,
                    max_retries: parseInt(document.getElementById('timeout_max_retries').value)
                };

                // ä¼˜åŒ–è®¾ç½®ï¼ˆå•ç‹¬ä¿å­˜ï¼‰
                const optimizationSettings = {
                    enable_cache_control_limit: document.getElementById('timeout_enable_cache_control_limit').checked
                };

                // å‰ç«¯æ ¡éªŒï¼šæ£€æŸ¥æ•°å­—å­—æ®µçš„å€¼æ˜¯å¦æœ‰æ•ˆï¼ˆè·³è¿‡å¸ƒå°”å€¼å­—æ®µï¼‰
                for (const [key, value] of Object.entries(settings)) {
                    if (key === 'modify_retry_headers') continue;
                    if (isNaN(value) || value <= 0) {
                        showToast(`é…ç½®é¡¹"${key}"çš„å€¼æ— æ•ˆï¼Œè¯·è¾“å…¥å¤§äº0çš„æ•°å­—`, 'error');
                        return;
                    }
                }

                const response = await fetch('/api/timeout', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                const data = await response.json();
                if (data.success) {
                    // ä¿å­˜è¶…æ—¶è®¾ç½®æˆåŠŸåï¼Œä¿å­˜ä¼˜åŒ–è®¾ç½®
                    const optResponse = await fetch('/api/optimization', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(optimizationSettings)
                    });
                    const optData = await optResponse.json();
                    if (optData.success) {
                        // æ ¹æ®æ˜¯å¦ä¸ºè‡ªåŠ¨ä¿å­˜æ˜¾ç¤ºä¸åŒæç¤º
                        if (isAutoSave) {
                            showAutoSaveIndicator();
                        } else {
                            showToast('æ‰€æœ‰è®¾ç½®å·²ä¿å­˜æˆåŠŸ', 'success');
                        }
                    } else {
                        showToast('è¶…æ—¶è®¾ç½®å·²ä¿å­˜ï¼Œä½†ä¼˜åŒ–è®¾ç½®ä¿å­˜å¤±è´¥: ' + optData.message, 'error');
                    }
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== Tokenç»Ÿè®¡æ¸²æŸ“ ==========
        let currentTokenPeriod = 'today'; // é»˜è®¤æ˜¾ç¤ºå½“å¤©æ•°æ®

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // ========== æ¨¡å‹ä»·æ ¼æ˜ å°„è¡¨ï¼ˆæ¯ç™¾ä¸‡tokençš„ä»·æ ¼ï¼Œå•ä½ï¼šUSDï¼‰ ==========
        const MODEL_PRICING = {
                // Claude Haiku æ¨¡å‹
                'claude-haiku-4-5-20251001': { input: 1.00, output: 5.00, cache_creation: 1.25, cache_read: 0.10 },
                'claude-haiku-3-5-20240307': { input: 0.80, output: 4.00, cache_creation: 1.00, cache_read: 0.08 },
                'claude-haiku-3-20240307': { input: 0.25, output: 1.25, cache_creation: 0.31, cache_read: 0.025 },

                // Claude Sonnet æ¨¡å‹
                'claude-sonnet-4-5-20250929': { input: 3.00, output: 15.00, cache_creation: 3.75, cache_read: 0.30 },
                'claude-sonnet-4-20240229': { input: 3.00, output: 15.00, cache_creation: 3.75, cache_read: 0.30 },
                'claude-sonnet-3-7-20250219': { input: 3.00, output: 15.00, cache_creation: 3.75, cache_read: 0.30 },
                'claude-sonnet-3-5-20240620': { input: 3.00, output: 15.00, cache_creation: 3.75, cache_read: 0.30 },

                // Claude Opus æ¨¡å‹
                'claude-opus-4-1-20250514': { input: 15.00, output: 75.00, cache_creation: 18.75, cache_read: 1.50 },

                // GPT Codex æ¨¡å‹ (90% cache discount - cache read is 10% of input price)
                'gpt-5.1-codex': { input: 1.25, output: 10.00, cache_creation: 1.25, cache_read: 0.125 },
                'gpt-5-codex': { input: 1.25, output: 10.00, cache_creation: 1.25, cache_read: 0.125 }
        };

        // è·å–æ¨¡å‹ä»·æ ¼çš„è¾…åŠ©å‡½æ•°ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰
        function getModelPricing(modelName) {
            // 1. ç²¾ç¡®åŒ¹é…
            if (MODEL_PRICING[modelName]) {
                return MODEL_PRICING[modelName];
            }

            // 2. æ¨¡ç³ŠåŒ¹é…ï¼ˆé€šè¿‡æ¨¡å‹åç§°å…³é”®è¯ï¼‰
            const lowerModel = modelName.toLowerCase();

            // Claude Haiku åŒ¹é…
            if (lowerModel.includes('haiku-4-5') || lowerModel.includes('haiku-4.5')) {
                return MODEL_PRICING['claude-haiku-4-5-20251001'];
            }
            if (lowerModel.includes('haiku-3-5') || lowerModel.includes('haiku-3.5')) {
                return MODEL_PRICING['claude-haiku-3-5-20240307'];
            }
            if (lowerModel.includes('haiku')) {
                return MODEL_PRICING['claude-haiku-3-20240307'];
            }

            // Claude Sonnet åŒ¹é…
            if (lowerModel.includes('sonnet-4-5') || lowerModel.includes('sonnet-4.5')) {
                return MODEL_PRICING['claude-sonnet-4-5-20250929'];
            }
            if (lowerModel.includes('sonnet')) {
                return MODEL_PRICING['claude-sonnet-4-20240229'];
            }

            // Claude Opus åŒ¹é…
            if (lowerModel.includes('opus')) {
                return MODEL_PRICING['claude-opus-4-1-20250514'];
            }

            // GPT Codex åŒ¹é…
            if (lowerModel.includes('codex') || lowerModel.includes('gpt-5')) {
                return MODEL_PRICING['gpt-5.1-codex'];
            }

            // 3. é»˜è®¤è¿”å› Sonnet 4.5 ä»·æ ¼ï¼ˆæœ€å¸¸ç”¨ï¼‰
            return MODEL_PRICING['claude-sonnet-4-5-20250929'];
        }

        // è®¡ç®—å•ä¸ªæ¨¡å‹çš„è´¹ç”¨
        function calculateModelCost(modelName, tokens) {
            const pricing = getModelPricing(modelName);
            const cost_usd = (
                (tokens.input || 0) * pricing.input / 1000000 +
                (tokens.output || 0) * pricing.output / 1000000 +
                (tokens.cache_creation || 0) * pricing.cache_creation / 1000000 +
                (tokens.cache_read || 0) * pricing.cache_read / 1000000
            );
            return {
                usd: cost_usd,
                cny: cost_usd * 7.2
            };
        }

        // æ ¹æ®æ—¶é—´èŒƒå›´è¿‡æ»¤å¹¶è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼ˆåŒ…å«æ±‡æ€»å’ŒæŒ‰æ¨¡å‹åˆ†ç»„ï¼‰
        function calculatePeriodSummary(statsData, period) {
            const dailyData = statsData.daily || {};
            const today = new Date();
            today.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå½“å¤©00:00:00

            // è®¡ç®—å¼€å§‹æ—¥æœŸ
            let startDate = new Date(today);
            if (period === 'today') {
                // å½“å¤©ï¼šä»ä»Šå¤©00:00:00å¼€å§‹
                startDate = new Date(today);
            } else if (period === '7days') {
                // 7å¤©ï¼šä»6å¤©å‰00:00:00å¼€å§‹(åŒ…æ‹¬ä»Šå¤©,å…±7å¤©)
                startDate.setDate(today.getDate() - 6);
            } else if (period === '30days') {
                // 30å¤©ï¼šä»29å¤©å‰00:00:00å¼€å§‹(åŒ…æ‹¬ä»Šå¤©,å…±30å¤©)
                startDate.setDate(today.getDate() - 29);
            }

            // åˆå§‹åŒ–æ±‡æ€»æ•°æ®
            const summary = {
                total_requests: 0,
                total_tokens: 0,
                total_input_tokens: 0,
                total_output_tokens: 0,
                total_cache_creation_tokens: 0,
                total_cache_read_tokens: 0,
                total_cost_usd: 0,
                total_cost_cny: 0
            };

            // åˆå§‹åŒ–æŒ‰æ¨¡å‹åˆ†ç»„çš„æ•°æ®
            const byModel = {};

            // éå†dailyæ•°æ®,è¿‡æ»¤å¹¶ç´¯åŠ ç¬¦åˆæ—¶é—´èŒƒå›´çš„æ•°æ®
            Object.keys(dailyData).forEach(dateKey => {
                const itemDate = new Date(dateKey + ' 00:00:00');
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨èŒƒå›´å†…
                if (itemDate >= startDate && itemDate <= today) {
                    const dayData = dailyData[dateKey];

                    // ç´¯åŠ æ±‡æ€»æ•°æ®
                    summary.total_requests += dayData.total_requests || 0;
                    summary.total_tokens += dayData.total_tokens || 0;
                    summary.total_input_tokens += dayData.total_input_tokens || 0;
                    summary.total_output_tokens += dayData.total_output_tokens || 0;
                    summary.total_cache_creation_tokens += dayData.total_cache_creation_tokens || 0;
                    summary.total_cache_read_tokens += dayData.total_cache_read_tokens || 0;

                    // ç´¯åŠ æŒ‰æ¨¡å‹åˆ†ç»„çš„æ•°æ®
                    const models = dayData.models || {};
                    Object.keys(models).forEach(modelName => {
                        const count = models[modelName];
                        if (!byModel[modelName]) {
                            byModel[modelName] = {
                                total_requests: 0,
                                total_tokens: 0,
                                total_input_tokens: 0,
                                total_output_tokens: 0,
                                total_cache_creation_tokens: 0,
                                total_cache_read_tokens: 0
                            };
                        }
                        byModel[modelName].total_requests += count;
                        // æ³¨æ„ï¼šdailyæ•°æ®ä¸­çš„modelsåªè®°å½•äº†è¯·æ±‚æ¬¡æ•°ï¼Œæ²¡æœ‰è¯¦ç»†çš„tokenæ•°æ®
                        // æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»å®Œæ•´çš„ç»Ÿè®¡æ•°æ®ä¸­è·å–æ¯ä¸ªæ¨¡å‹çš„tokenä¿¡æ¯
                    });
                }
            });

            // ä»å®Œæ•´çš„by_modelæ•°æ®ä¸­æå–å‘¨æœŸå†…çš„è¯¦ç»†ä¿¡æ¯
            // è¿™é‡Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ¨¡å‹åœ¨å‘¨æœŸå†…çš„è¯·æ±‚å æ¯”æ¥ä¼°ç®—token
            const fullByModel = statsData.by_model || {};
            Object.keys(byModel).forEach(modelName => {
                if (fullByModel[modelName]) {
                    const fullStats = fullByModel[modelName];
                    const periodRequests = byModel[modelName].total_requests;
                    const fullRequests = fullStats.total_requests || 1;
                    const ratio = periodRequests / fullRequests;

                    // æŒ‰æ¯”ä¾‹åˆ†é…tokenæ•°æ®
                    byModel[modelName].total_tokens = Math.round((fullStats.total_tokens || 0) * ratio);
                    byModel[modelName].total_input_tokens = Math.round((fullStats.total_input_tokens || 0) * ratio);
                    byModel[modelName].total_output_tokens = Math.round((fullStats.total_output_tokens || 0) * ratio);
                    byModel[modelName].total_cache_creation_tokens = Math.round((fullStats.total_cache_creation_tokens || 0) * ratio);
                    byModel[modelName].total_cache_read_tokens = Math.round((fullStats.total_cache_read_tokens || 0) * ratio);
                }
            });

            // è®¡ç®—æ€»è´¹ç”¨
            let total_cost_usd = 0;
            Object.entries(byModel).forEach(([model, stats]) => {
                const cost = calculateModelCost(model, {
                    input: stats.total_input_tokens,
                    output: stats.total_output_tokens,
                    cache_creation: stats.total_cache_creation_tokens,
                    cache_read: stats.total_cache_read_tokens
                });
                total_cost_usd += cost.usd;
            });

            summary.total_cost_usd = total_cost_usd;
            summary.total_cost_cny = total_cost_usd * 7.2;

            // è¿”å›åŒ…å«æ±‡æ€»å’ŒæŒ‰æ¨¡å‹åˆ†ç»„çš„æ•°æ®
            return {
                summary: summary,
                by_model: byModel
            };
        }

        function renderTokenStats(statsData) {
            const list = document.getElementById('configsList');

            // æ ¹æ®å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´è®¡ç®—æ±‡æ€»æ•°æ®å’ŒæŒ‰æ¨¡å‹åˆ†ç»„çš„æ•°æ®
            const periodData = calculatePeriodSummary(statsData, currentTokenPeriod);
            const periodSummary = periodData.summary;
            const byModel = periodData.by_model; // ä½¿ç”¨è¿‡æ»¤åçš„by_modelæ•°æ®

            let html = '<div style="padding: 20px;">';
            html += '<h3 style="margin-bottom: 20px; color: #333;">ğŸ“Š Tokenä½¿ç”¨é‡ç»Ÿè®¡</h3>';

            // æ§åˆ¶æŒ‰é’®
            html += '<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">';
            html += '<button class="btn btn-primary" id="tokenBtnToday" onclick="changeTokenPeriod(\'today\')">å½“å¤©ç»Ÿè®¡</button>';
            html += '<button class="btn btn-secondary" id="tokenBtn7days" onclick="changeTokenPeriod(\'7days\')">7å¤©ç»Ÿè®¡</button>';
            html += '<button class="btn btn-secondary" id="tokenBtn30days" onclick="changeTokenPeriod(\'30days\')">30å¤©ç»Ÿè®¡</button>';
            html += '<button class="btn btn-success" onclick="refreshTokenStats()" style="margin-left: auto;">ğŸ”„ åˆ·æ–°æ˜¾ç¤º</button>';
            html += '<button class="btn btn-danger" onclick="resetTokenStats()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>';
            html += '<small style="color: #666; margin-left: 10px; line-height: 38px;">ğŸ’¡ æ•°æ®å®æ—¶è‡ªåŠ¨æ›´æ–°</small>';
            html += '</div>';

            // å‘¨æœŸæ ‡ç­¾æç¤º
            const periodLabels = {
                'today': 'å½“å¤©',
                '7days': 'æœ€è¿‘7å¤©',
                '30days': 'æœ€è¿‘30å¤©'
            };
            html += '<div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #1976d2;">';
            html += `ğŸ“Š å½“å‰æ˜¾ç¤ºï¼š<strong>${periodLabels[currentTokenPeriod] || 'å½“å¤©'}</strong>ç´¯è®¡æ•°æ®`;
            html += '</div>';

            // ç»Ÿè®¡å¡ç‰‡ - ä½¿ç”¨å‘¨æœŸæ±‡æ€»æ•°æ®
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">';

            const stats = [
                { label: 'æ€»è¯·æ±‚æ•°', value: periodSummary.total_requests || 0, icon: 'ğŸ“ˆ', color: '#667eea' },
                { label: 'æ€»Tokenæ•°', value: periodSummary.total_tokens || 0, icon: 'ğŸ’', color: '#764ba2' },
                { label: 'è¾“å…¥Token', value: periodSummary.total_input_tokens || 0, icon: 'ğŸ“¥', color: '#28a745' },
                { label: 'è¾“å‡ºToken', value: periodSummary.total_output_tokens || 0, icon: 'ğŸ“¤', color: '#dc3545' },
                { label: 'ç¼“å­˜åˆ›å»ºToken', value: periodSummary.total_cache_creation_tokens || 0, icon: 'ğŸ’¾', color: '#ffc107' },
                { label: 'ç¼“å­˜è¯»å–Token', value: periodSummary.total_cache_read_tokens || 0, icon: 'âš¡', color: '#17a2b8' },
                { label: 'æ€»è´¹ç”¨(USD)', value: '$' + (periodSummary.total_cost_usd || 0).toFixed(4), icon: 'ğŸ’µ', color: '#e74c3c', isText: true },
                { label: 'æ€»è´¹ç”¨(CNY)', value: 'Â¥' + (periodSummary.total_cost_cny || 0).toFixed(2), icon: 'ğŸ’°', color: '#e67e22', isText: true }
            ];

            stats.forEach(stat => {
                const displayValue = stat.isText ? stat.value : formatNumber(stat.value);
                html += `
                    <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid ${stat.color};">
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${stat.icon} ${stat.label}</div>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">${displayValue}</div>
                    </div>
                `;
            });

            html += '</div>';

            // æ¨¡å‹ç»Ÿè®¡è¡¨
            html += '<div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">';
            html += '<h4 style="margin-bottom: 20px; color: #333;">ğŸ¤– æ¨¡å‹ä½¿ç”¨è¯¦æƒ…</h4>';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: left; border-radius: 5px 0 0 0;">æ¨¡å‹åç§°</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right;">è¯·æ±‚æ¬¡æ•°</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right;">æ€»Token</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right;">è¾“å…¥Token</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right;">è¾“å‡ºToken</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right;">ç¼“å­˜åˆ›å»º</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right;">ç¼“å­˜è¯»å–</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right;">è´¹ç”¨(USD)</th>';
            html += '<th style="background: #667eea; color: white; padding: 12px; text-align: right; border-radius: 0 5px 5px 0;">è´¹ç”¨(CNY)</th>';
            html += '</tr></thead><tbody>';

            Object.entries(byModel).forEach(([model, stats]) => {
                // è®¡ç®—è¯¥æ¨¡å‹çš„è´¹ç”¨
                const modelCost = calculateModelCost(model, {
                    input: stats.total_input_tokens,
                    output: stats.total_output_tokens,
                    cache_creation: stats.total_cache_creation_tokens,
                    cache_read: stats.total_cache_read_tokens
                });

                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 12px; font-weight: 600; color: #333;">${model}</td>`;
                html += `<td style="padding: 12px; text-align: right;">${formatNumber(stats.total_requests)}</td>`;
                html += `<td style="padding: 12px; text-align: right; font-weight: 600;">${formatNumber(stats.total_tokens)}</td>`;
                html += `<td style="padding: 12px; text-align: right;">${formatNumber(stats.total_input_tokens)}</td>`;
                html += `<td style="padding: 12px; text-align: right;">${formatNumber(stats.total_output_tokens)}</td>`;
                html += `<td style="padding: 12px; text-align: right;">${formatNumber(stats.total_cache_creation_tokens)}</td>`;
                html += `<td style="padding: 12px; text-align: right;">${formatNumber(stats.total_cache_read_tokens)}</td>`;
                html += `<td style="padding: 12px; text-align: right; color: #e74c3c; font-weight: 600;">$${modelCost.usd.toFixed(4)}</td>`;
                html += `<td style="padding: 12px; text-align: right; color: #e67e22; font-weight: 600;">Â¥${modelCost.cny.toFixed(2)}</td>`;
                html += '</tr>';
            });

            if (Object.keys(byModel).length === 0) {
                html += '<tr><td colspan="9" style="padding: 20px; text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
            }

            html += '</tbody></table>';
            html += '</div>';

            html += '</div>';
            list.innerHTML = html;
        }

        function changeTokenPeriod(period) {
            currentTokenPeriod = period;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('tokenBtnToday').className = period === 'today' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('tokenBtn7days').className = period === '7days' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('tokenBtn30days').className = period === '30days' ? 'btn btn-primary' : 'btn btn-secondary';

            // é‡æ–°åŠ è½½æ•°æ®
            loadConfigs();
        }

        async function refreshTokenStats() {
            try {
                showToast('æ­£åœ¨ç”Ÿæˆç»Ÿè®¡æ•°æ®...', 'success');

                // è§¦å‘ç”Ÿæˆç»Ÿè®¡
                await fetch('/api/token-stats/generate', { method: 'POST' });

                // é‡æ–°åŠ è½½
                await loadConfigs();

                showToast('æ•°æ®åˆ·æ–°æˆåŠŸï¼', 'success');
            } catch (error) {
                showToast('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function resetTokenStats() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            try {
                showToast('æ­£åœ¨æ¸…ç©ºç»Ÿè®¡æ•°æ®...', 'success');

                const response = await fetch('/api/token-stats/reset', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    // é‡æ–°åŠ è½½
                    await loadConfigs();
                    showToast('ç»Ÿè®¡æ•°æ®å·²æ¸…ç©ºï¼', 'success');
                } else {
                    showToast('æ¸…ç©ºå¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== é”™è¯¯å¤„ç†ç­–ç•¥æ¸²æŸ“å’Œä¿å­˜ ==========
        function renderErrorStrategies(strategies) {
            const list = document.getElementById('configsList');
            const strategyColors = {
                'strategy_retry': '#4CAF50',
                'switch_api': '#FF9800',
                'normal_retry': '#2196F3'
            };
            const strategyLabels = {
                'strategy_retry': 'ç­–ç•¥é‡è¯•(è¶…æ—¶é‡è¯•)',
                'switch_api': 'APIåˆ‡æ¢',
                'normal_retry': 'ä¸é‡è¯•'
            };
            const strategyDescriptions = {
                'strategy_retry': 'ä¾æ¬¡å°è¯•è¶…æ—¶é‡è¯•é…ç½®åˆ—è¡¨ä¸­çš„å¤‡ç”¨èŠ‚ç‚¹',
                'switch_api': 'ç«‹å³åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªAPI KEYå¹¶è®°å½•é”™è¯¯',
                'normal_retry': 'ç›´æ¥è¿”å›é”™è¯¯ç»™ç”¨æˆ·ï¼Œä¸è¿›è¡Œä»»ä½•é‡è¯•'
            };

            // HTTPçŠ¶æ€ç é”™è¯¯å®šä¹‰
            const httpStatusCodes = {
                '400': { name: 'Bad Request', desc: 'è¯·æ±‚æ ¼å¼é”™è¯¯ï¼Œå¯èƒ½æ˜¯å‚æ•°é—®é¢˜' },
                '401': { name: 'Unauthorized', desc: 'æœªæˆæƒï¼ŒKEYå¯èƒ½æ— æ•ˆ' },
                '403': { name: 'Forbidden', desc: 'ç¦æ­¢è®¿é—®ï¼ŒKEYå¯èƒ½è¢«å°ç¦' },
                '404': { name: 'Not Found', desc: 'èµ„æºä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯APIç«¯ç‚¹å˜æ›´' },
                '408': { name: 'Request Timeout', desc: 'è¯·æ±‚è¶…æ—¶ï¼ŒæœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿' },
                '429': { name: 'Too Many Requests', desc: 'è¯·æ±‚è¿‡å¤šï¼Œè§¦å‘é™æµ' },
                '500': { name: 'Internal Server Error', desc: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' },
                '502': { name: 'Bad Gateway', desc: 'ç½‘å…³é”™è¯¯ï¼Œä¸Šæ¸¸æœåŠ¡å¼‚å¸¸' },
                '503': { name: 'Service Unavailable', desc: 'æœåŠ¡ä¸å¯ç”¨ï¼Œå¯èƒ½ç»´æŠ¤ä¸­' },
                '504': { name: 'Gateway Timeout', desc: 'ç½‘å…³è¶…æ—¶ï¼Œä¸Šæ¸¸æœåŠ¡å™¨å“åº”è¶…æ—¶' },
                '520': { name: 'Web Server Error', desc: 'Cloudflare: æœåŠ¡å™¨è¿”å›æœªçŸ¥é”™è¯¯' },
                '521': { name: 'Web Server Down', desc: 'Cloudflare: æœåŠ¡å™¨æ‹’ç»è¿æ¥' },
                '522': { name: 'Connection Timed Out', desc: 'Cloudflare: è¿æ¥è¶…æ—¶' },
                '524': { name: 'Timeout Occurred', desc: 'Cloudflare: å¤„ç†è¶…æ—¶' },
                'default': { name: 'å…¶ä»–æœªåˆ—å‡ºçš„é”™è¯¯', desc: 'æ‰€æœ‰æœªæ˜ç¡®åˆ—å‡ºçš„HTTPçŠ¶æ€ç çš„é»˜è®¤å¤„ç†ç­–ç•¥' }
            };

            // ç½‘ç»œé”™è¯¯å®šä¹‰
            const networkErrors = {
                'ReadError': { name: 'SSLè¯»å–é”™è¯¯', desc: 'ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­SSLè¿æ¥å¼‚å¸¸æ–­å¼€ï¼Œå¯èƒ½æ˜¯èŠ‚ç‚¹ä¸ç¨³å®š' },
                'ConnectError': { name: 'è¿æ¥å¤±è´¥', desc: 'æ— æ³•å»ºç«‹TCPè¿æ¥ï¼Œå¯èƒ½æ˜¯èŠ‚ç‚¹å®•æœºæˆ–ç½‘ç»œä¸é€š' },
                'ReadTimeout': { name: 'è¯»å–è¶…æ—¶', desc: 'ç­‰å¾…å“åº”æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½æ˜¯èŠ‚ç‚¹è´Ÿè½½é«˜æˆ–ä»»åŠ¡å¤æ‚' },
                'default': { name: 'å…¶ä»–ç½‘ç»œé”™è¯¯', desc: 'æ‰€æœ‰æœªæ˜ç¡®åˆ—å‡ºçš„ç½‘ç»œå¼‚å¸¸çš„é»˜è®¤å¤„ç†ç­–ç•¥' }
            };

            let html = '<div style="padding: 20px;">';
            html += '<h3 style="margin-bottom: 20px;">âš ï¸ é”™è¯¯å¤„ç†ç­–ç•¥é…ç½®</h3>';
            html += '<div style="margin-bottom: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">';
            html += '<div style="font-weight: 600; color: #856404; margin-bottom: 8px;">ğŸ’¡ ç­–ç•¥è¯´æ˜</div>';
            html += '<div style="font-size: 13px; color: #856404; line-height: 1.6;">';
            html += 'â€¢ <span style="color: ' + strategyColors['strategy_retry'] + '; font-weight: 600;">ç­–ç•¥é‡è¯•</span>: ' + strategyDescriptions['strategy_retry'] + '<br>';
            html += 'â€¢ <span style="color: ' + strategyColors['switch_api'] + '; font-weight: 600;">APIåˆ‡æ¢</span>: ' + strategyDescriptions['switch_api'] + '<br>';
            html += 'â€¢ <span style="color: ' + strategyColors['normal_retry'] + '; font-weight: 600;">ä¸é‡è¯•</span>: ' + strategyDescriptions['normal_retry'];
            html += '</div></div>';

            // HTTPçŠ¶æ€ç é”™è¯¯ç»„
            html += '<div style="margin-bottom: 30px;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<h4 style="color: #333; margin: 0;">ğŸ“Š HTTPçŠ¶æ€ç é”™è¯¯</h4>';
            html += '<div>';
            html += '<button onclick="batchSetHttpStrategy(\'strategy_retry\')" style="padding: 6px 12px; margin-right: 5px; background: ' + strategyColors['strategy_retry'] + '; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">å…¨éƒ¨è®¾ä¸ºç­–ç•¥é‡è¯•</button>';
            html += '<button onclick="batchSetHttpStrategy(\'switch_api\')" style="padding: 6px 12px; background: ' + strategyColors['switch_api'] + '; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">å…¨éƒ¨è®¾ä¸ºAPIåˆ‡æ¢</button>';
            html += '</div></div>';

            Object.entries(httpStatusCodes).forEach(([code, info]) => {
                const currentStrategy = strategies.http_status_codes?.[code] || 'strategy_retry';
                html += '<div style="display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #e8e8e8; border-radius: 6px; margin-bottom: 10px;">';
                html += '<div style="flex: 1;">';
                html += `<div style="font-weight: 600; color: #333; margin-bottom: 4px;">${code} - ${info.name}</div>`;
                html += `<div style="font-size: 12px; color: #666;">${info.desc}</div>`;
                html += '</div>';
                html += '<select id="http_' + code + '" style="padding: 8px 12px; border: 2px solid ' + strategyColors[currentStrategy] + '; border-radius: 4px; background: white; cursor: pointer; font-weight: 600; color: ' + strategyColors[currentStrategy] + ';" onchange="updateStrategyColor(this)">';
                Object.entries(strategyLabels).forEach(([value, label]) => {
                    html += '<option value="' + value + '" ' + (currentStrategy === value ? 'selected' : '') + '>' + label + '</option>';
                });
                html += '</select>';
                html += '</div>';
            });

            html += '</div>';

            // ç½‘ç»œé”™è¯¯ç»„
            html += '<div style="margin-bottom: 30px;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<h4 style="color: #333; margin: 0;">ğŸŒ åº•å±‚ç½‘ç»œé”™è¯¯</h4>';
            html += '<div>';
            html += '<button onclick="batchSetNetworkStrategy(\'switch_api\')" style="padding: 6px 12px; background: ' + strategyColors['switch_api'] + '; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">å…¨éƒ¨è®¾ä¸ºAPIåˆ‡æ¢</button>';
            html += '</div></div>';

            Object.entries(networkErrors).forEach(([errorType, info]) => {
                const currentStrategy = strategies.network_errors?.[errorType] || 'switch_api';
                html += '<div style="display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #e8e8e8; border-radius: 6px; margin-bottom: 10px;">';
                html += '<div style="flex: 1;">';
                html += `<div style="font-weight: 600; color: #333; margin-bottom: 4px;">${errorType} - ${info.name}</div>`;
                html += `<div style="font-size: 12px; color: #666;">${info.desc}</div>`;
                html += '</div>';
                html += '<select id="network_' + errorType + '" style="padding: 8px 12px; border: 2px solid ' + strategyColors[currentStrategy] + '; border-radius: 4px; background: white; cursor: pointer; font-weight: 600; color: ' + strategyColors[currentStrategy] + ';" onchange="updateStrategyColor(this)">';
                Object.entries(strategyLabels).forEach(([value, label]) => {
                    html += '<option value="' + value + '" ' + (currentStrategy === value ? 'selected' : '') + '>' + label + '</option>';
                });
                html += '</select>';
                html += '</div>';
            });

            html += '</div>';

            // ä¿å­˜æŒ‰é’®
            html += '<div style="text-align: center; margin-top: 30px;">';
            html += '<button onclick="saveErrorStrategies()" style="padding: 12px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">ğŸ’¾ ä¿å­˜é…ç½®</button>';
            html += '</div>';
            
            html += '</div>';
            list.innerHTML = html;
        }

        function updateStrategyColor(selectElement) {
            const strategyColors = {
                'strategy_retry': '#4CAF50',
                'switch_api': '#FF9800',
                'normal_retry': '#2196F3'
            };
            const selectedValue = selectElement.value;
            selectElement.style.borderColor = strategyColors[selectedValue];
            selectElement.style.color = strategyColors[selectedValue];
        }

        function batchSetHttpStrategy(strategy) {
            const httpCodes = ['400', '401', '403', '404', '408', '429', '500', '502', '503', '504', '520', '521', '522', '524', 'default'];
            httpCodes.forEach(code => {
                const select = document.getElementById('http_' + code);
                if (select) {
                    select.value = strategy;
                    updateStrategyColor(select);
                }
            });
        }

        function batchSetNetworkStrategy(strategy) {
            const networkTypes = ['ReadError', 'ConnectError', 'ReadTimeout', 'default'];
            networkTypes.forEach(type => {
                const select = document.getElementById('network_' + type);
                if (select) {
                    select.value = strategy;
                    updateStrategyColor(select);
                }
            });
        }

        async function saveErrorStrategies() {
            const httpCodes = ['400', '401', '403', '404', '408', '429', '500', '502', '503', '504', '520', '521', '522', '524', 'default'];
            const networkTypes = ['ReadError', 'ConnectError', 'ReadTimeout', 'default'];

            const strategies = {
                http_status_codes: {},
                network_errors: {}
            };

            httpCodes.forEach(code => {
                const select = document.getElementById('http_' + code);
                if (select) {
                    strategies.http_status_codes[code] = select.value;
                }
            });

            networkTypes.forEach(type => {
                const select = document.getElementById('network_' + type);
                if (select) {
                    strategies.network_errors[type] = select.value;
                }
            });

            try {
                const response = await fetch('/api/error-strategies', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(strategies)
                });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        loadConfigs();
        
        // åˆå§‹åŒ–é‡ç½®å†·å´æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
        const resetCooldownBtn = document.getElementById('resetCooldownBtn');
        if (currentTab === 'api' || currentTab === 'codex') {
            resetCooldownBtn.style.display = 'inline-block';
        }
    </script>
</body>
</html>









